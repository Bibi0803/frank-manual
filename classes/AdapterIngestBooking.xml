<adapter name="IngestBooking">
  <receiver name="input">
    <ApiListener
        name="inputListener"
        uriPattern="booking"
        method="POST"/>
  </receiver>
  <pipeline firstPipe="checkInput">
    <exits>
      <exit path="Exit" state="success" code="201" />
      <exit path="ServerError" state="failure" code="500" />
    </exits>
    &checkInput;
    <SenderPipe
        name="insertBooking">
      <FixedQuerySender
          name="insertBookingSender"
          query="INSERT INTO booking VALUES(?, ?, ?, ?)"
          jmsRealm="jdbc">
        <param name="id" xpathExpression="/booking/@id" />
        <param name="travelerId" xpathExpression="/booking/travelerId" />
        <param name="price" xpathExpression="/booking/price" />
        <param name="fee" xpathExpression="/booking/fee" />
      </FixedQuerySender>
      <forward name="success" path="getDestinations" />
      <forward name="failure" path="ServerError" />
    </SenderPipe>
    <XsltPipe
        name="getDestinations"
        styleSheetName="booking2destinations.xsl"
        getInputFromSessionKey="originalMessage">
      <forward name="success" path="iterateDestinations"/>
      <forward name="failure" path="ServerError"/>
    </XsltPipe>
    <ForEachChildElementPipe
        name="iterateDestinations"
        elementXpathExpression="/destinations/destination">
      <FixedQuerySender
          name="insertVisitSender"
          query="INSERT INTO visit VALUES(?, ?, ?, ?, ?, ?, ?)"
          jmsRealm="jdbc">
        <param name="bookingId" xpathExpression="/destination/bookingId" />
        <param name="seq" xpathExpression="/destination/seq" />
        <param name="hostId" xpathExpression="/destination/hostId" />
        <param name="productId" xpathExpression="/destination/productId" />
        <param name="startDate" xpathExpression="/destination/startDate" />
        <param name="endDate" xpathExpression="/destination/endDate" />
        <param name="price" xpathExpression="/destination/price" />
      </FixedQuerySender>
      <forward name="success" path="Exit"/>
      <forward name="failure" path="ServerError"/>
    </ForEachChildElementPipe>
  </pipeline>
</adapter>
