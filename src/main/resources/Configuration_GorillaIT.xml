<?xml version="1.0" encoding="UTF-8"?>
<module>
	<adapter name="GorillaIT"
		description="Extracts a list of educational institutions">
		<receiver
			className="nl.nn.adapterframework.receivers.GenericReceiver"
			name="GorrillaIT">
			<listener
				className="nl.nn.adapterframework.receivers.JavaListener"
				name="GorillaIT_Listener" />
		</receiver>

		<pipeline firstPipe="removeTestAPipelineMessage">
			<exits>
				<exit path="EXIT" state="success" code="200" />
				<exit path="ServerError" state="failure" code="500" />
			</exits>
			<pipe name="removeTestAPipelineMessage" 
				className="nl.nn.adapterframework.pipes.FixedResult"
				returnString="">
				<forward name="failure" path="ServerError" />
				<forward name="succes" path="getEdudexInfo" />
			</pipe>
			<pipe name="getEdudexInfo" active="${stubEdudex.active}"
				className="nl.nn.adapterframework.pipes.FixedResult"
				fileName="Gorilla/input.xml">
				<forward name="failure" path="ServerError" />
				<forward name="succes" path="GetInfoFromSomewhere" />
			</pipe>
			<pipe name="getEdudexInfo" active="!${stubEdudex.active}"
				className="nl.nn.adapterframework.pipes.GenericMessageSendingPipe">
				<sender className="nl.nn.adapterframework.http.HttpSender"
					verifyHostname="false"
					allowSelfSignedCertificates ="true"
					throwException="false"
					url="https://feeds.edudex.nl/institutes/prodis/feed/?key=2ec767ad9ada6f6c4a4f541e0e98d102">
				</sender>
				<forward name="failure" path="ServerError" />
				<forward name="success" path="processDirectoryUrl" />
			</pipe>
			<pipe name="processDirectoryUrl"
				className="nl.nn.adapterframework.pipes.ForEachChildElementPipe"
				elementXPathExpression="edudexDirectory/subDirectory[1] | edudexDirectory/subDirectory[2]"
				>
				<sender
					className="nl.nn.adapterframework.senders.IbisLocalSender"
					javaListener="ProcessDirectoryUrl">
					<param name="directoryUrl"
						xpathExpression="subDirectory/directoryUrl" />
					<param name="orgUnitId"
						xpathExpression="subDirectory/orgUnitId" />
				</sender>
				<forward name="exception" path="EXIT"/>
				<forward name="success" path="EXIT" />
			</pipe>
		</pipeline>
	</adapter>

	<adapter name="ProcessDirectoryUrl"
		description="Gets a list of educational programs">
		<receiver name="ProcessDirectoryUrl"
			className="nl.nn.adapterframework.receivers.GenericReceiver">
			<listener name="ProcessDirectoryUrl"
				className="nl.nn.adapterframework.receivers.JavaListener" />
		</receiver>

		<pipeline firstPipe="getProgramResourceInfo">
			<exits>
				<exit path="EXIT" state="success" />
				<exit path="ServerError" state="failure" code="500" />
			</exits>
			<pipe name="getProgramResourceInfo"
				active="${stubEdudex.active}"
				className="nl.nn.adapterframework.pipes.FixedResult"
				fileName="Gorilla/input2.xml">
				<forward name="failure" path="ServerError" />
				<forward name="succes" path="getResourceInfo" />
			</pipe>
			<pipe name="getProgramResourceInfo"
				active="!${stubEdudex.active}"
				className="nl.nn.adapterframework.pipes.GenericMessageSendingPipe">
				<sender className="nl.nn.adapterframework.http.HttpSender"
						verifyHostname="false"
						allowSelfSignedCertificates ="true"
					>
				<param name="url" sessionKey="directoryUrl"/>
				</sender>
				<forward name="exception" path="EXIT"/>
				<forward name="failure" path="ServerError" />
				<forward name="success" path="getResourceInfo" />
			</pipe>
			<pipe name="getResourceInfo"
				className="nl.nn.adapterframework.pipes.ForEachChildElementPipe"
				elementXPathExpression="edudexDirectory/programResource">
				<sender
					className="nl.nn.adapterframework.senders.IbisLocalSender"
					javaListener="GetProgram">
					<param name="orgUnitId" sessionKey="orgUnitId" />
				</sender>
				<forward name="success" path="EXIT" />
			</pipe>
		</pipeline>
	</adapter>

	<adapter name="GetProgram"
		description="This adapter will Fetch one program and inserts the data into the db">
		<receiver name="GetProgram"
			className="nl.nn.adapterframework.receivers.GenericReceiver">
			<listener name="GetProgram"
				className="nl.nn.adapterframework.receivers.JavaListener" />
		</receiver>

		<pipeline firstPipe="put param in session">
			<exits>
				<exit path="EXIT" state="success" />
				<exit path="ServerError" state="failure" code="500" />
			</exits>
			<pipe name="put param in session"  className="nl.nn.adapterframework.pipes.PutParametersInSession">
			<param name="programId" xpathExpression="programResource/programId"/>
			<param name="programUrl" xpathExpression="programResource/resourceUrl"/>
			<forward name="success" path="getProgramResourceInfo"/>
			</pipe>
			<pipe name="getProgramResourceInfo"
					active="${stubEdudex.active}"
					className="nl.nn.adapterframework.pipes.FixedResult"
					storeResultInSessionKey="ResourceInfo"
					fileName="Gorilla/input3.xml">
					<forward name="exception" path="EXIT"/>
					<forward name="failure" path="ServerError" />
					<forward name="succes" path="InsertIntoPrograms" />
				</pipe>
				<pipe name="getProgramResourceInfo"
					active="!${stubEdudex.active}"
					storeResultInSessionKey="ResourceInfo"
					className="nl.nn.adapterframework.pipes.GenericMessageSendingPipe">
					<sender className="nl.nn.adapterframework.http.HttpSender"
						verifyHostname="false"
						allowSelfSignedCertificates ="true"
						throwException="false"
						>
						<param name="url" sessionKey="programUrl"/>
				</sender>
				<forward name="exception" path="EXIT"/>
				<forward name="failure" path="ServerError" />
				
				<!-- Change this when doing real inserts... -->
				<forward name="success" path="EXIT" />
			</pipe>
			<pipe name="InsertIntoPrograms"
				className="nl.nn.adapterframework.pipes.GenericMessageSendingPipe">
				<sender
					className="nl.nn.adapterframework.jdbc.FixedQuerySender"
					jmsRealm="jdbc"
					query="INSERT INTO Programs (orgunitid, programid) 
				VALUES (?,?)">
					<param name="orgUnitId"	sessionKey="orgUnitId" />
					<param name="programId"	sessionKey="programId" />
				</sender>
				<forward name="exception" path="EXIT"/>
				<forward name="failure" path="ServerError" />
				<forward name="success" path="storeContactdata" />
			</pipe>
			
			<pipe name="storeContactdata"
				className="nl.nn.adapterframework.pipes.ForEachChildElementPipe"
				getInputFromSessionKey="ResourceInfo"
				elementXPathExpression="program/programContacts/contactData">
				<sender
					className="nl.nn.adapterframework.jdbc.FixedQuerySender"
					jmsRealm="jdbc"
					query="INSERT INTO programcontacts (orgunitid, programid, contactname, email, role, telephone) 
					VALUES (?,?,?,?,?,?)"
					>
					<param name="programId"	sessionKey="programId" defaultValue="null" />
					<param name="orgUnitId" sessionKey="orgUnitId" defaultValue="null"/>
					<param name="contactname" xpathExpression="contactData/contactName" defaultValue="null" />
					<param name="email" xpathExpression="contactData/email" defaultValue="null"/>
					<param name="role" xpathExpression="contactData/role" defaultValue="null"/>
					<param name="telephone" xpathExpression="contactData/telephone" defaultValue="null"/>
				</sender>
				<forward name="success" path="EXIT" />
			</pipe>
			
			<pipe name="storeProgramRun"
				className="nl.nn.adapterframework.pipes.ForEachChildElementPipe"
				getInputFromSessionKey="ResourceInfo"
				elementXPathExpression="program/programSchedule/programRun">
				<sender
					className="nl.nn.adapterframework.senders.IbisLocalSender"
					javaListener="StoreProgramRun"
					/>
				<forward name="success" path="EXIT" />
			</pipe>
		</pipeline>
	</adapter>
	
	<adapter name="StoreProgramRun"
		description="Stores the ProgramRun element into the Db">
		<receiver name="StoreProgramRun"
			className="nl.nn.adapterframework.receivers.GenericReceiver">
			<listener name="StoreProgramRun"
				className="nl.nn.adapterframework.receivers.JavaListener" />
		</receiver>

		<pipeline firstPipe="storeProgramRunData">
			<exits>
				<exit path="EXIT" state="success" />
				<exit path="ServerError" state="failure" code="500" />
			</exits>
			<pipe name="storeProgramRunData"
				className="nl.nn.adapterframework.pipes.ForEachChildElementPipe"
				elementXPathExpression="programRun">
				<sender
					className="nl.nn.adapterframework.jdbc.FixedQuerySender"
					jmsRealm="jdbc"
					query="INSERT INTO programrun (programid, status,startdate, enddate ) 
					VALUES (?,?,?,?)"
					>
					<param name="programid" xpathExpression="programRun/id" defaultValue="null"/>
					<param name="status" xpathExpression="programRun/status" defaultValue="null"/>
					<param name="startdate" xpathExpression="programRun/startDate" defaultValue="null"/>
					<param name="enddate" xpathExpression="programRun/endDate" defaultValue="null"/>
				</sender>
				<forward name="success" path="storeProgramRunData_Modules" />
			</pipe>
			
			<pipe name="storeProgramRunData_Modules"
				className="nl.nn.adapterframework.pipes.ForEachChildElementPipe"
				getInputFromSessionKey="originalMessage"
				elementXPathExpression="programRun/module">
				<sender
					className="nl.nn.adapterframework.jdbc.FixedQuerySender"
					jmsRealm="jdbc"
					query="INSERT INTO programrun_module (programid, name, startdate, enddate, locationaddress, locationzipcode, locationcity ) 
					VALUES (?,?,?,?,?,?,?)"
					>
					<param name="programid" sessionKey="originalMessage" xpathExpression="programRun/id" defaultValue="null"/>
					<param name="name" xpathExpression="module/name" defaultValue="null"/>
					<param name="startdate" xpathExpression="module/startDate" defaultValue="null"/>
					<param name="enddate" xpathExpression="module/endDate" defaultValue="null"/>
					<param name="locationaddress," xpathExpression="module/location/address" defaultValue="null"/>
					<param name="locationzipcode," xpathExpression="module/location/zipcode" defaultValue="null"/>
					<param name="locationcity" xpathExpression="module/location/city" defaultValue="null"/>
				</sender>
				<forward name="success" path="storeProgramRunData_Cost" />
			</pipe>
			
			<pipe name="storeProgramRunData_Cost"
				className="nl.nn.adapterframework.pipes.ForEachChildElementPipe"
				getInputFromSessionKey="originalMessage"
				elementXPathExpression="programRun/cost">
				<sender
					className="nl.nn.adapterframework.jdbc.FixedQuerySender"
					jmsRealm="jdbc"
					query="INSERT INTO programrun_cost (programid, amount ,amountvat ,amountisfinal ) 
					VALUES (?,?,?,?)"
					>
					<param name="programid" sessionKey="originalMessage" xpathExpression="programRun/id" defaultValue="null"/>
					<param name="amount" xpathExpression="cost/amount" defaultValue="null"/>
					<param name="amountvat" xpathExpression="cost/amountVAT" defaultValue="null"/>
					<param name="amountisfinal" xpathExpression="cost/amountIsFinal" defaultValue="null"/>
				</sender>
				<forward name="success" path="EXIT" />
			</pipe>
		</pipeline>
	</adapter>	
	
		<adapter name="Cleanup"
		description="Empties the database">
		<receiver name="Cleanup"
			className="nl.nn.adapterframework.receivers.GenericReceiver">
			<listener name="Cleanup"
				className="nl.nn.adapterframework.receivers.JavaListener" />
		</receiver>

		<pipeline firstPipe="emptyPrograms">
			<exits>
				<exit path="EXIT" state="success" />
				<exit path="ServerError" state="failure" code="500" />
			</exits>
			<pipe name="emptyPrograms"
				className="nl.nn.adapterframework.pipes.GenericMessageSendingPipe"
				>
				<sender
					className="nl.nn.adapterframework.jdbc.FixedQuerySender"
					jmsRealm="jdbc"
					query="DELETE FROM PROGRAMS"
					>
				</sender>
				<forward name="success" path="emptyProgramcontacts" />
			</pipe>
			
				<pipe name="emptyProgramcontacts"
				className="nl.nn.adapterframework.pipes.GenericMessageSendingPipe"
				>
				<sender
					className="nl.nn.adapterframework.jdbc.FixedQuerySender"
					jmsRealm="jdbc"
					query="DELETE FROM PROGRAMCONTACTS"
					>
				</sender>
				<forward name="success" path="emptyProgramRun" />
			</pipe>
			
							<pipe name="emptyProgramRun"
				className="nl.nn.adapterframework.pipes.GenericMessageSendingPipe"
				>
				<sender
					className="nl.nn.adapterframework.jdbc.FixedQuerySender"
					jmsRealm="jdbc"
					query="DELETE FROM PROGRAMRUN"
					>
				</sender>
				<forward name="success" path="emptyProgramrun_module" />
			</pipe>
			
			<pipe name="emptyProgramrun_module"
				className="nl.nn.adapterframework.pipes.GenericMessageSendingPipe"
				>
				<sender
					className="nl.nn.adapterframework.jdbc.FixedQuerySender"
					jmsRealm="jdbc"
					query="DELETE FROM PROGRAMRUN_MODULE"
					>
				</sender>
				<forward name="success" path="emptyProgramrun_cost" />
			</pipe>
			
			<pipe name="emptyProgramrun_cost"
				className="nl.nn.adapterframework.pipes.GenericMessageSendingPipe"
				>
				<sender
					className="nl.nn.adapterframework.jdbc.FixedQuerySender"
					jmsRealm="jdbc"
					query="DELETE FROM PROGRAMRUN_COST"
					>
				</sender>
				<forward name="success" path="EXIT" />
			</pipe>
		</pipeline>
	</adapter>	
	
</module>
